---
asyncapi: 3.0.0
info:
  title: DwiLive Real-Time API
  version: 1.0.0
  description: |
    The WebSocket contract for DwiLive (v3.0.0).
    Handles real-time events that occur AFTER a user has fetched their room list via REST.
    **Protocol:** Socket.io                     
    **Auth:** Handshake query `?token=JWT` (or `username` for MVP)
servers:
  local:
    host: localhost:3001
    protocol: socket.io
    description: Local Development Server
channels:
  rootChannel:
    address: /
    messages:
      # --- DEFINITIONS IN THE CHANNEL ---
      clientJoinRoom:
        $ref: '#/components/messages/ClientJoinRoom'
      clientSendMessage:
        $ref: '#/components/messages/ClientSendMessage'
      clientTyping:
        $ref: '#/components/messages/ClientTyping'
      clientLeaveRoom:
        $ref: '#/components/messages/ClientLeaveRoom'
      serverReceiveMessage:
        $ref: '#/components/messages/ServerReceiveMessage'
      serverUserJoined:
        $ref: '#/components/messages/ServerUserJoined'
      serverUserLeft:
        $ref: '#/components/messages/ServerUserLeft'
      serverTypingIndicator:
        $ref: '#/components/messages/ServerTypingIndicator'
operations:
  # ----------------------------
  # CLIENT -> SERVER (Receiving)
  # ----------------------------
  onJoinRoom:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client asks to join a room
    messages:
      - $ref: '#/channels/rootChannel/messages/clientJoinRoom'
  onSendMessage:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client sends a message
    messages:
      - $ref: '#/channels/rootChannel/messages/clientSendMessage'
  onTypingStart:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client indicates typing status
    messages:
      - $ref: '#/channels/rootChannel/messages/clientTyping'
  onLeaveRoom:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client explicitly leaves a room
    messages:
      - $ref: '#/channels/rootChannel/messages/clientLeaveRoom'

  # ----------------------------
  # SERVER -> CLIENT (Sending)
  # ----------------------------
  broadcastMessage:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server broadcasts a new message to the room
    messages:
      - $ref: '#/channels/rootChannel/messages/serverReceiveMessage'
  notifyUserJoined:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server notifies room that someone joined
    messages:
      - $ref: '#/channels/rootChannel/messages/serverUserJoined'
  notifyUserLeft:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server notifies room that someone left
    messages:
      - $ref: '#/channels/rootChannel/messages/serverUserLeft'
  broadcastTyping:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server broadcasts typing indicator
    messages:
      - $ref: '#/channels/rootChannel/messages/serverTypingIndicator'
components:
  messages:
    # --- MESSAGE COMPONENT DEFINITIONS ---
    ClientJoinRoom:
      name: join_room
      title: Join Room
      payload:
        type: object
        required: [roomId]
        properties:
          roomId:
            type: string
            format: uuid
    ClientSendMessage:
      name: send_message
      title: Send Message
      payload:
        type: object
        required: [roomId, content]
        properties:
          roomId:
            type: string
            format: uuid
          content:
            type: string
          type:
            type: string
            enum: [text, image]
            default: text
    ClientTyping:
      name: typing_start
      title: Typing Indicator
      payload:
        type: object
        required: [roomId]
        properties:
          roomId:
            type: string
    ClientLeaveRoom:
      name: leave_room
      title: Leave Room
      payload:
        type: object
        required: [roomId]
        properties:
          roomId:
            type: string
    ServerReceiveMessage:
      name: receive_message
      title: Incoming Message
      payload:
        type: object
        properties:
          id:
            type: string
            format: uuid
          roomId:
            type: string
          author:
            type: object
            properties:
              id:
                type: string
              username:
                type: string
              avatarUrl:
                type: string
          content:
            type: string
          createdAt:
            type: string
            format: date-time
    ServerUserJoined:
      name: user_joined
      title: User Joined
      payload:
        type: object
        properties:
          roomId:
            type: string
          user:
            type: object
            properties:
              id:
                type: string
              username:
                type: string
    ServerUserLeft:
      name: user_left
      title: User Left
      payload:
        type: object
        properties:
          roomId:
            type: string
          userId:
            type: string
    ServerTypingIndicator:
      name: display_typing
      title: Display Typing
      payload:
        type: object
        properties:
          roomId:
            type: string
          username:
            type: string
          isTyping:
            type: boolean
