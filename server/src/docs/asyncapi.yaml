asyncapi: 3.0.0
info:
  title: DwiLive Real-Time API
  version: 1.0.1
  description: |
    The WebSocket contract for DwiLive (v3.0.0).
    Handles real-time events that occur AFTER a user has fetched their conversation list via REST.
    **Protocol:** Socket.io                     
    **Auth:** Handshake query `?token=JWT` (or `username` for MVP)
servers:
  local:
    host: localhost:3001
    protocol: socket.io
    description: Local Development Server
channels:
  rootChannel:
    address: /
    messages:
      # --- DEFINITIONS IN THE CHANNEL ---
      clientJoinConversation:
        $ref: '#/components/messages/ClientJoinConversation'
      clientSendMessage:
        $ref: '#/components/messages/ClientSendMessage'
      clientTypingStart:
        $ref: '#/components/messages/ClientTypingStart'
      clientTypingStop:
        $ref: '#/components/messages/ClientTypingStop'
      clientLeaveConversation:
        $ref: '#/components/messages/ClientLeaveConversation'
      serverReceiveMessage:
        $ref: '#/components/messages/ServerReceiveMessage'
      serverUserJoined:
        $ref: '#/components/messages/ServerUserJoined'
      serverUserLeft:
        $ref: '#/components/messages/ServerUserLeft'
      serverTypingIndicator:
        $ref: '#/components/messages/ServerTypingIndicator'
operations:
  # ----------------------------
  # CLIENT -> SERVER (Receiving)
  # ----------------------------
  onJoinConversation:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client asks to join a conversation
    messages:
      - $ref: '#/channels/rootChannel/messages/clientJoinConversation'
  onSendMessage:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client sends a message
    messages:
      - $ref: '#/channels/rootChannel/messages/clientSendMessage'
  onTypingStart:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client indicates typing status has started
    messages:
      - $ref: '#/channels/rootChannel/messages/clientTypingStart'
  onTypingStop:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client indicates typing status has stopped
    messages:
      - $ref: '#/channels/rootChannel/messages/clientTypingStop'
  onLeaveConversation:
    action: receive
    channel:
      $ref: '#/channels/rootChannel'
    summary: Client explicitly leaves a conversation
    messages:
      - $ref: '#/channels/rootChannel/messages/clientLeaveConversation'

  # ----------------------------
  # SERVER -> CLIENT (Sending)
  # ----------------------------
  broadcastMessage:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server broadcasts a new message to the conversation
    messages:
      - $ref: '#/channels/rootChannel/messages/serverReceiveMessage'
  notifyUserJoined:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server notifies conversation that someone joined
    messages:
      - $ref: '#/channels/rootChannel/messages/serverUserJoined'
  notifyUserLeft:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server notifies conversation that someone left
    messages:
      - $ref: '#/channels/rootChannel/messages/serverUserLeft'
  broadcastTyping:
    action: send
    channel:
      $ref: '#/channels/rootChannel'
    summary: Server broadcasts typing indicator
    messages:
      - $ref: '#/channels/rootChannel/messages/serverTypingIndicator'
components:
  messages:
    # --- MESSAGE COMPONENT DEFINITIONS ---
    ClientJoinConversation:
      name: conversation:join
      title: Join Conversation
      payload:
        type: object
        required: [conversationId]
        properties:
          conversationId:
            type: string
            format: uuid
    ClientSendMessage:
      name: message:send
      title: Send Message
      payload:
        type: object
        required: [conversationId, content]
        properties:
          conversationId:
            type: string
            format: uuid
          content:
            type: string
          type:
            type: string
            enum: [text, image]
            default: text
    ClientTypingStart:
      name: typing:start
      title: Typing Indicator Start
      payload:
        type: object
        required: [conversationId]
        properties:
          conversationId:
            type: string
    ClientTypingStop:
      name: typing:stop
      title: Typing Indicator Stop
      payload:
        type: object
        required: [conversationId]
        properties:
          conversationId:
            type: string
    ClientLeaveConversation:
      name: conversation:leave
      title: Leave Conversation
      payload:
        type: object
        required: [conversationId]
        properties:
          conversationId:
            type: string
    ServerReceiveMessage:
      name: message:receive
      title: Incoming Message
      payload:
        type: object
        properties:
          id:
            type: string
            format: uuid
          conversationId:
            type: string
          author:
            type: object
            properties:
              id:
                type: string
              username:
                type: string
              avatarUrl:
                type: string
          content:
            type: string
          createdAt:
            type: string
            format: date-time
    ServerUserJoined:
      name: conversation:user_joined
      title: User Joined
      payload:
        type: object
        properties:
          conversationId:
            type: string
          user:
            type: object
            properties:
              id:
                type: string
              username:
                type: string
    ServerUserLeft:
      name: conversation:user_left
      title: User Left
      payload:
        type: object
        properties:
          conversationId:
            type: string
          userId:
            type: string
    ServerTypingIndicator:
      name: typing:display
      title: Display Typing
      payload:
        type: object
        properties:
          conversationId:
            type: string
          username:
            type: string
          isTyping:
            type: boolean
  schemas:
    SocketResponse:
      type: object
      oneOf:
        - $ref: '#/components/schemas/SocketResponseSuccess'
        - $ref: '#/components/schemas/SocketResponseError'
    SocketResponseSuccess:
      type: object
      properties:
        status:
          type: string
          enum: [OK]
        data:
          type: object
    SocketResponseError:
      type: object
      properties:
        status:
          type: string
          enum: [ERROR]
        error:
          type: string
        code:
          type: string
          enum: [UNAUTHORIZED, VALIDATION_ERROR, INTERNAL_SERVER_ERROR]
